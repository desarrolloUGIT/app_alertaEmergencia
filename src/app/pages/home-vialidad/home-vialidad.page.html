<ion-header>
  <ion-toolbar mode="ios">
    <ion-buttons slot="start" >
      <ion-menu-button style="color: white;" ></ion-menu-button>
    </ion-buttons>
    <ion-title>
      Crear Alerta
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content force-overscroll="false">
  <mat-stepper orientation="vertical"  #stepper>
    <!-- Selección de Activo -->
    <mat-step >
      <ng-template matStepLabel>Activo</ng-template>
      <form [formGroup]="firstFormGroup">
        <div  id="container" *ngIf="mostrarMapa"> 
          <div id="custom-buttonV" class="custom-buttonV" *ngIf="(stepper.selectedIndex == 0)" >
            <div (click)='customZoom()' class="icon-button">
                <ion-icon name="map-outline"></ion-icon>
            </div>
            <div (click)='obtenerGeolocalizacion()' class="icon-button">
              <ion-icon name="locate-outline"></ion-icon>
            </div>
          </div>
        </div>
        <ion-card center>
          <span>({{dataPosicion.lat}},{{dataPosicion.lng}})</span><br>
          <h3 *ngIf="dataPosicion.region != ''" style="font-weight: bold;"><span *ngIf="firstFormGroup.value.activoSeleccionado" style="font-size: 13px;">{{firstFormGroup.value.activoSeleccionado.nombre_camino}} ~ Rol: {{firstFormGroup.value.activoSeleccionado.rol}}<br></span> Región: {{dataPosicion.region}}</h3>
          <ion-grid *ngIf="caminosEncontrados.length > 1">
            <ion-row style="margin-top: -12%;" (click)="openModalCaminos()">
              <ion-col size="9">
                <h4 style="margin: 0;margin-top: 8%;margin-left: 8%;">Seleccione Camino </h4>
              </ion-col>
              <ion-col size="3" align="left">
                <ion-button shape="circle" class="pulse" ><ion-icon slot="icon-only" name="search"></ion-icon></ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>
          <div *ngIf="firstFormGroup.value.activoSeleccionado">
            <ion-item lines="none" style="width: 100%;">
              <ion-label slot="start" style="font-size: 15px;font-weight: bold;width: 30%;">KM Inicio</ion-label>
              <ion-input formControlName="km_i" mode="ios" placeholder="{{km_i}}" [class.error]="menorI || mayorI || mayorIF" (ionInput)="myFunction($event,'i')" clearInput="true" inputmode="decimal" style="border: 1px solid darkgray;border-radius: 5px;padding-left: 5px !important;"></ion-input>
            </ion-item>
            <p *ngIf="menorI" class="p_error">No puede ser menor al km {{km_i}}</p>
            <p *ngIf="mayorI" class="p_error">No puede ser mayor al km {{km_f}}</p>
            <p *ngIf="mayorIF" class="p_error">No puede ser mayor al km final</p>
            <ion-item lines="none" style="width: 100%;">
              <ion-label slot="start" style="font-size: 15px;font-weight: bold;width: 30%;">KM Término</ion-label>
              <ion-input formControlName="km_f" mode="ios" placeholder="{{km_f}}" [class.error]="mayorF || menorF || menorFI" (ionInput)="myFunction($event,'f')" clearInput="true" inputmode="decimal" style="border: 1px solid darkgray;border-radius: 5px;padding-left: 5px !important;"></ion-input>
            </ion-item>
            <p *ngIf="menorF" class="p_error">No puede ser menor al km {{km_i}}</p>
            <p *ngIf="mayorF" class="p_error">No puede ser mayor al km {{km_f}}</p>
            <p *ngIf="menorFI" class="p_error">No puede ser menor al km  inicial</p>
            <ion-item lines="none" style="width: 100%;">
              <ion-label  style="font-size: 15px;font-weight: bold;">Fecha Emergencia</ion-label>
              <span  *ngIf="!firstFormGroup.value.fechaEmergencia" (click)="abrirModal()" class="fechaHora">dd/mm/yy hh:mm</span>
              <span  *ngIf="firstFormGroup.value.fechaEmergencia" class="fechaHora" style="margin:0;text-decoration: underline;" (click)="abrirModal()">{{firstFormGroup.value.fechaEmergencia | date:'dd/MM/yy hh:mm a'}}</span>
            </ion-item>
          </div>
        </ion-card>        
      </form>
      <div align="center" >
        <ion-button fill="clear" color="dark" (click)="moverStepperr('next')">
          Continuar <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
        </ion-button>
      </div>
    </mat-step>
    <!-- Operatividad y Daño -->
    <mat-step>
      <form [formGroup]="secondFormGroup">
        <ng-template matStepLabel>Operatividad y daño</ng-template>
        <ion-card center>
          <ion-label style="font-size: 17px;">Detalle Emergencia</ion-label>
          <ion-list style="margin-top: 3%;margin-bottom: 3%;">
            <ion-item lines="none" [class.select]="secondFormGroup.value.transito">
              <ion-label >Tránsito</ion-label>
              <ion-select mode="ios" interface="alert" placeholder="Selecciona tránsito" class="select-text" cancelText="Cancelar" okText="OK" title="Tránsito" formControlName="transito">
                <ion-select-option *ngFor="let item of transito" [value]="item.VALUE">{{item.VALUE}}</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item lines="none" *ngIf="secondFormGroup.value.transito == 'Con Restricción'" [class.select]="secondFormGroup.value.restriccion">
              <ion-label >Restricción</ion-label>
              <ion-select mode="ios" interface="alert" placeholder="Selecciona restricción" class="select-text" cancelText="Cancelar" okText="OK" title="Restricción" formControlName="restriccion">
                <ion-select-option *ngFor="let item of restriccion" [value]="item.VALUE">{{item.DESCRIPTION}}</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item lines="none" [class.select]="secondFormGroup.value.nivelAlerta">
              <ion-label>Nivel de alerta</ion-label>
              <ion-select mode="ios" interface="alert" placeholder="Selecciona alerta" class="select-text"  cancelText="Cancelar" okText="OK" title="Alerta" formControlName="nivelAlerta">
                <ion-select-option *ngFor="let item of nivelAlertaArray" [value]="item.VALUE">{{item.DESCRIPTION}}</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item lines="none" [class.select]="secondFormGroup.value.elemento">
              <ion-label>Elemento</ion-label>
              <ion-select mode="ios" interface="alert" placeholder="Selecciona elemento" class="select-text"  cancelText="Cancelar" okText="OK" title="Elemento" formControlName="elemento">
                <ion-select-option *ngFor="let item of elementos" [value]="item.VALUE">{{item.DESCRIPTION}}</ion-select-option>
              </ion-select>
            </ion-item>
            <ion-item lines="none" [class.select]="secondFormGroup.value.competencia">
              <ion-label>Competencia</ion-label>
              <ion-select mode="ios" interface="alert" placeholder="Selecciona competencia" class="select-text"  cancelText="Cancelar" okText="OK" title="Competencia" formControlName="competencia">
                <ion-select-option *ngFor="let item of competencia" [value]="item.valor">{{item.valor}} - {{item.descripcion}}</ion-select-option>
              </ion-select>
            </ion-item>
          </ion-list>
        </ion-card>
        <div align="center" >
          <ion-button fill="clear" color="dark" (click)="moverStepperr('previus')">
            Volver <ion-icon slot="start" name="chevron-back-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" color="dark" (click)="moverStepperr('next')">
            Continuar <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
          </ion-button>
        </div>
      </form>
    </mat-step>
    <!-- Datos adicionales -->
    <mat-step>
      <ng-template matStepLabel>Datos Adicioanles</ng-template>
      <form [formGroup]="thirdFormGroup">
        <ion-card center>
          <ion-item>
            <ion-label position="stacked">Resumen</ion-label>
            <ion-textarea formControlName="titulo" placeholder="" clearInput="true" type="" style="--placeholder-color:black;resize: none;" rows="2" maxlength="100"></ion-textarea>
          </ion-item>
          <span style="float: right;margin-right: 2%;">{{thirdFormGroup.value.titulo ? thirdFormGroup.value.titulo.length : '0'}}/100</span>
        </ion-card>
        <ion-card center>
          <ion-item>
            <ion-label position="stacked">Descripción detallada</ion-label>
            <ion-textarea formControlName="descripcion" placeholder="" clearInput="true" type="" style="--placeholder-color:black;resize: none;" rows="5" maxlength="300"></ion-textarea>
          </ion-item>
          <span style="float: right;margin-right: 2%;margin-bottom: 3%;">{{thirdFormGroup.value.descripcion ? thirdFormGroup.value.descripcion.length : '0'}}/300</span>
        </ion-card>

        <ion-list style="margin-top: 5%;background: transparent;" lines="none">
          <ion-item-sliding *ngFor="let file of images;let i = index" >
            <ion-item style="--background: transparent;">
              <ion-img [src]="file.data" style="height: 80%;width: 100%;"></ion-img>
            </ion-item>
            <ion-item-options  side="end">
              <ion-item-option expandable color="danger"  (click)="deleteImage(file)"><ion-icon slot="icon-only" name="trash"></ion-icon>Eliminar</ion-item-option>
            </ion-item-options>
          </ion-item-sliding>
        </ion-list>
        <ion-button expand="block" color="medium" (click)="presentActionSheet()">Adjuntar Foto</ion-button>
      </form>
      <div align="center" >
        <ion-button fill="clear" color="dark" (click)="moverStepperr('previus')">
          Volver <ion-icon slot="start" name="chevron-back-outline"></ion-icon>
        </ion-button>
        <ion-button fill="clear" color="dark" (click)="moverStepperr('next')">
          Continuar <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
        </ion-button>
      </div>
    </mat-step>
    <!-- Resumen -->
    <mat-step>
      <ng-template matStepLabel>Resumen</ng-template>
      <ion-grid style="border: 1px solid black;border-radius: 5px;padding: 0;padding-bottom: 1%;">
        <ion-row align="center" class="tituloTable" style="background: #008dff45;">
          <ion-col size="4" class="cierreTabla"><ion-label style="color: black;">Dato</ion-label></ion-col>
          <ion-col size="5" class="cierreTabla"><ion-label style="color: black;">Información</ion-label></ion-col>
          <ion-col size="3" class="cierreTabla"><ion-label style="color: black;">Estado</ion-label></ion-col>
        </ion-row>
        <ion-row align="center">
          <ion-col size="4" class="cierreTabla"><ion-label style="color: black;">Resumen</ion-label></ion-col>
          <ion-col size="5" class="cierreTabla"><ion-label style="color: black;">{{thirdFormGroup.value.titulo}}</ion-label></ion-col>
          <ion-col size="3" class="cierreTabla"><ion-icon style="font-size: 23px;" [style.color]="(thirdFormGroup.value.titulo != '' && thirdFormGroup.value.titulo) ? 'green' : 'red'" [name]="(thirdFormGroup.value.titulo != '' && thirdFormGroup.value.titulo) ? 'checkmark-outline': 'alert-circle'"></ion-icon></ion-col>
        </ion-row>
        <ion-row align="center" style="background: #008dff45;">
          <ion-col size="4" class="cierreTabla"><ion-label style="color: black;">Camino</ion-label></ion-col>
          <ion-col size="5" class="cierreTabla"><ion-label style="color: black;" *ngIf="firstFormGroup.value.activoSeleccionado">{{firstFormGroup.value.activoSeleccionado.nombre_camino}}</ion-label></ion-col>
          <ion-col size="3" class="cierreTabla"><ion-icon style="font-size: 23px;" [style.color]="(firstFormGroup.value.activoSeleccionado != '' && firstFormGroup.value.activoSeleccionado) ? 'green' : 'red'" [name]="(firstFormGroup.value.activoSeleccionado != '' && firstFormGroup.value.activoSeleccionado) ? 'checkmark-outline': 'alert-circle'"></ion-icon></ion-col>
        </ion-row>
        <ion-row align="center">
          <ion-col size="4" class="cierreTabla"><ion-label style="color: black;">Fecha</ion-label></ion-col>
          <ion-col size="5" class="cierreTabla"><ion-label style="color: black;">{{firstFormGroup.value.fechaEmergencia | date:'dd/MM/yy hh:mm a'}}</ion-label></ion-col>
          <ion-col size="3" class="cierreTabla"><ion-icon style="font-size: 23px;" [style.color]="(firstFormGroup.value.fechaEmergencia != '' && firstFormGroup.value.fechaEmergencia) ? 'green' : 'red'" [name]="(firstFormGroup.value.fechaEmergencia != '' && firstFormGroup.value.fechaEmergencia) ? 'checkmark-outline': 'alert-circle'"></ion-icon></ion-col>
        </ion-row>
        <ion-row align="center" style="background: #008dff45;">
          <ion-col size="4" class="cierreTabla"><ion-label style="color: black;">KM Inicio</ion-label></ion-col>
          <ion-col size="5" class="cierreTabla"><ion-label style="color: black;"><span *ngIf="firstFormGroup.value.km_i"> Km</span> {{firstFormGroup.value.km_i}} </ion-label></ion-col>
          <ion-col size="3" class="cierreTabla"><ion-icon style="font-size: 23px;" [style.color]="(firstFormGroup.value.km_i != '' && firstFormGroup.value.km_i) ? 'green' : 'red'" [name]="(firstFormGroup.value.km_i != '' && firstFormGroup.value.km_i) ? 'checkmark-outline': 'alert-circle'"></ion-icon></ion-col>
        </ion-row>
        <ion-row align="center">
          <ion-col size="4" class="cierreTabla"><ion-label style="color: black;">KM Término</ion-label></ion-col>
          <ion-col size="5" class="cierreTabla"><ion-label style="color: black;"><span *ngIf="firstFormGroup.value.km_f"> Km</span> {{firstFormGroup.value.km_f}} </ion-label></ion-col>
          <ion-col size="3" class="cierreTabla"><ion-icon style="font-size: 23px;" [style.color]="(firstFormGroup.value.km_f != '' && firstFormGroup.value.km_f) ? 'green' : 'red'" [name]="(firstFormGroup.value.km_f != '' && firstFormGroup.value.km_f) ? 'checkmark-outline': 'alert-circle'"></ion-icon></ion-col>
        </ion-row>
        <ion-row align="center" style="background: #008dff45;">
          <ion-col size="4" class="cierreTabla"><ion-label style="color: black;">Tránsito</ion-label></ion-col>
          <ion-col size="5" class="cierreTabla"><ion-label style="color: black;">{{secondFormGroup.value.transito}}</ion-label></ion-col>
          <ion-col size="3" class="cierreTabla"><ion-icon style="font-size: 23px;" [style.color]="(secondFormGroup.value.transito != '' && secondFormGroup.value.transito) ? 'green' : 'red'" [name]="(secondFormGroup.value.transito != '' && secondFormGroup.value.transito) ? 'checkmark-outline': 'alert-circle'"></ion-icon></ion-col>
        </ion-row>
        <ion-row align="center" *ngIf="secondFormGroup.value.transito == 'Con Restricción'">
          <ion-col size="4" class="cierreTabla"><ion-label style="color: black;">Restricción</ion-label></ion-col>
          <ion-col size="5" class="cierreTabla"><ion-label style="color: black;">{{secondFormGroup.value.restriccion}}</ion-label></ion-col>
          <ion-col size="3" class="cierreTabla"><ion-icon style="font-size: 23px;" [style.color]="(secondFormGroup.value.restriccion != '' && secondFormGroup.value.restriccion) ? 'green' : 'red'" [name]="(secondFormGroup.value.restriccion != '' && secondFormGroup.value.restriccion) ? 'checkmark-outline': 'alert-circle'"></ion-icon></ion-col>
        </ion-row>
        <ion-row align="center" [style.background]="secondFormGroup.value.transito == 'Con Restricción' ? '#008dff45' : 'white'">
          <ion-col size="4" class="cierreTabla"><ion-label style="color: black;">Nivel</ion-label></ion-col>
          <ion-col size="5" class="cierreTabla"><ion-label style="color: black;">{{secondFormGroup.value.nivelAlerta}}</ion-label></ion-col>
          <ion-col size="3" class="cierreTabla"><ion-icon style="font-size: 23px;" [style.color]="(secondFormGroup.value.nivelAlerta != '' && secondFormGroup.value.nivelAlerta) ? 'green' : 'red'" [name]="(secondFormGroup.value.nivelAlerta != '' && secondFormGroup.value.nivelAlerta) ? 'checkmark-outline': 'alert-circle'"></ion-icon></ion-col>
        </ion-row>
        <ion-row align="center" *ngIf="secondFormGroup.value.elemento" [style.background]="secondFormGroup.value.transito == 'Con Restricción' ? 'white' : '#008dff45'">
          <ion-col size="4" class="cierreTabla"><ion-label style="color: black;">Elemento</ion-label></ion-col>
          <ion-col size="5" class="cierreTabla"><ion-label style="color: black;">{{secondFormGroup.value.elemento}}</ion-label></ion-col>
          <ion-col size="3" class="cierreTabla"><ion-icon style="font-size: 23px;" [style.color]="(secondFormGroup.value.elemento != '' && secondFormGroup.value.elemento) ? 'green' : 'red'" [name]="(secondFormGroup.value.elemento != '' && secondFormGroup.value.elemento) ? 'checkmark-outline': 'alert-circle'"></ion-icon></ion-col>
        </ion-row>
        <ion-row align="center" [style.background]="secondFormGroup.value.transito == 'Con Restricción' ? (secondFormGroup.value.elemento ? '#008dff45' : 'white') : (secondFormGroup.value.elemento ? 'white' : '#008dff45')">
          <ion-col size="4" class="cierreTabla"><ion-label style="color: black;">Competencia</ion-label></ion-col>
          <ion-col size="5" class="cierreTabla"><ion-label style="color: black;">{{secondFormGroup.value.competencia}}</ion-label></ion-col>
          <ion-col size="3" class="cierreTabla"><ion-icon style="font-size: 23px;" [style.color]="(secondFormGroup.value.competencia != '' && secondFormGroup.value.competencia) ? 'green' : 'red'" [name]="(secondFormGroup.value.competencia != '' && secondFormGroup.value.competencia) ? 'checkmark-outline': 'alert-circle'"></ion-icon></ion-col>
        </ion-row>
        <ion-row align="center" [style.background]="secondFormGroup.value.transito == 'Con Restricción' ? (secondFormGroup.value.elemento ? 'white' : '#008dff45') : (secondFormGroup.value.elemento ? '#008dff45' : 'white')">
          <ion-col size="4" class="cierreTabla"><ion-label style="color: black;">Descripción detallada</ion-label></ion-col>
          <ion-col size="5" class="cierreTabla"><p style="color: black;text-align: left;">{{thirdFormGroup.value.descripcion}}</p></ion-col>
          <ion-col size="3" class="cierreTabla"><ion-icon style="font-size: 23px;" [style.color]="(thirdFormGroup.value.descripcion != '' && thirdFormGroup.value.descripcion) ? 'green' : 'red'" [name]="(thirdFormGroup.value.descripcion) ? 'checkmark-outline': 'alert-circle'"></ion-icon></ion-col>
        </ion-row>
      </ion-grid>
      <div align="center" >
        <ion-button fill="clear" color="dark" (click)="moverStepperr('previus')">
          Volver <ion-icon slot="start" name="chevron-back-outline"></ion-icon>
        </ion-button>
      </div>
      <div align="center" >
        <ion-button expand="block"  color="medium" (click)="enviar()"  [disabled]="!firstFormGroup.valid  || !secondFormGroup.valid || !thirdFormGroup.valid || !dataPosicion.lat || !dataPosicion.lng || !dataPosicion.region || mayorI || mayorF || menorI || menorF || menorFI || mayorIF">
          REPORTAR <ion-icon slot="start" name="cloud-upload-outline"></ion-icon>
        </ion-button>
      </div>
    </mat-step>
    <!-- Fin resumen -->
  </mat-stepper>
  <ion-modal #modal trigger="open-modal" [enterAnimation]="enterAnimation" [leaveAnimation]="leaveAnimation">
    <ng-template>
      <ion-content>
        <form [formGroup]="firstFormGroup">
        <ion-datetime first-day-of-week="1" size="cover" locale="es-MX" formControlName="fechaEmergencia" color="dark"
        showDefaultButtons="true" mode="ios"
        done-text="Aceptar"  cancel-text="Cancelar">
          <span slot="title" style="font-weight: bold;">Selecciona la Fecha de la emergencia</span>
          <span slot="time-label">Hora</span>
        </ion-datetime>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
